<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The Digital Services Team at Metropolitan New York Library Council" /><link rel="canonical" href="http://docs.archipelago.nyc/archipelago-deployment-live-moveToLive/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Moving from archipelago-deployment to archipelago-deployment-live - Pala Archipelago Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Moving from archipelago-deployment to archipelago-deployment-live";
        var mkdocs_page_input_path = "archipelago-deployment-live-moveToLive.md";
        var mkdocs_page_url = "/archipelago-deployment-live-moveToLive/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../images/dhammacakka.png" class="logo" alt="Logo"/>
        </a>
        <div class="version">
          {'provider': 'mike', 'default': 'default'}
        </div><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">About Archipelago</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ourtake/">Archipelago's Philosophy & Guiding Principles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../strawberryfields/">Strawberryfields Forever</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../devops/">Software Services</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT/">Code of Conduct</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Instructions and Guides</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="#">Archipelago-Deployment</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-readme/">Start</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-osx/">Installing Archipelago Drupal 9 on OSX (macOS)</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-ubuntu/">Installing Archipelago Drupal 9 on Ubuntu 18.04 or 20.04</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-democontent/">Adding Demo Archipelago Digital Objects (ADOs) to your Repository</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-upgradeFromD8ToD9/">Upgrading Drupal 8 to Drupal 9 (1.0.0-RC2 to 1.0.0-RC3)</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Archipelago-Deployment-Live</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-live-readme/">Start</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-live-gitworkflow/">Github Workflow</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Moving from archipelago-deployment to archipelago-deployment-live</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#what-is-this-documentation-for">What is this documentation for?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#what-is-this-documentation-not-for">What is this documentation not for?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#differences-between-both-deployments-strategies">Differences between both deployments strategies.</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#commonalities-between-both-deployment-strategies">Commonalities between both deployment strategies.</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#getting-the-new-repo-in-place">Getting the new repo in place</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#backing-up">Backing up</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#step-1">Step 1:</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#step-2">Step 2:</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#step-3">Step 3:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-directory-structures">The directory structures</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-data">The Data</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#copying-the-data-into-the-new-structure">Copying the Data into the new Structure</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-web">The Web</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#copying-the-web-into-the-new-structure">Copying the Web into the new Structure</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ssl-enviromentals-configurations-settings-and-docker">SSL, Enviromentals, Configurations, Settings and Docker</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#shutdown-the-old-one-start-the-new-one">Shutdown the old one, start the new one</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-live-upgradeFromD8ToD9/">Upgrading Drupal 8 to Drupal 9 (1.0.0-RC2 to 1.0.0-RC3)</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Archipelago 101</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="#">Digital Objects and Collections, Metadata, General Workflows</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../firstobject/">Ingesting Your First Object</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Webforms in Archipelago</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../webforms/">Webforms</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../webformsasinput/">How to Create a Webform as an Input Method for Archipelago Digital Objects (ADO)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../modifyingfileextensionsinwebform/">Customizing Webforms (Modifying allowable file extensions)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../customwebformelements/">Archipelago Custom Webform Elements</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Twig Templates and Archipelago</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../metadatatwigs/">Twig Templates and Archipelago</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../workingtwigs/">Working With Twig in Archipelago (getting started with custom Twig templates)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Archipelago Multi-Importer (AMI)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../ami_index/">Archipelago Multi-Importer (AMI)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="#">AMI Instructions and Guides</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../annotations/">Annotations</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Site Administration & Configuration</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../strawberryfield-formatters/">Strawberryfield Formatters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../createdisplaymodes/">Creating Display Modes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archifilepersistencestrategy/">Archipelago's File Persistence Strategy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../sslsetup/">How to Set Up SSL for Docker/Archipelago</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../xdebug/">Debugging PHP in Archipelago</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">General Q&A</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_index/">General Q&A</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_twig_modules_configuration/">Twig Modules Configuration</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_smtp_configuration/">SMTP Configuration</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_minio_logging/">Min.io Logging</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional Information</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../presentations_docs/">Archipelago Presentations and Documents</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inthewild/">Archipelagos in the Wild</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../giveortake/">Contribution Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../about/">About This Documentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../acknowledgments/">Care & Coding + Fixing / Acknowledgments / License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Pala Archipelago Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Instructions and Guides &raquo;</li>
          <li>Archipelago-Deployment-Live &raquo;</li>
      <li>Moving from archipelago-deployment to archipelago-deployment-live</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="moving-from-archipelago-deployment-to-archipelago-deployment-live">Moving from <code>archipelago-deployment</code> to <code>archipelago-deployment-live</code></h1>
<h2 id="what-is-this-documentation-for">What is this documentation for?</h2>
<p>If you have been using/running/populating an instance with Archipelago Digital Objects that was set up using our simpler-to-deploy but harder-to-customize <a href="https://github.com/esmero/archipelago-deployment">archipelago-deployment</a> strategy and can't wait to move to this one—meant for a larger (and somehow easier to maintain and upgrade on the long run) instance—but (wait!) you do not want to ingest again, set up again, configure users, etc. (You already did that!), this is your documentation.</p>
<h2 id="what-is-this-documentation-not-for">What is this documentation not for?</h2>
<p>To install an <code>archipelago-deployment-live</code> from scratch or to keep (forever) syncing between the two deployment options in a quantum phase shifting eternum like a time crystal.</p>
<h2 id="requirements">Requirements</h2>
<ul>
<li>An instance of Archipelago (working, tested) installed using <code>archipelago-deployment</code> as a basis.</li>
<li>Basic knowledge and instincts on how to run Terminal Commands, copy files, run <code>composer</code>, <code>drush</code>, Linux Permissions, and <code>git</code> of course.</li>
<li>Patience. You can't skip steps here. Also, Patience again since you may have stretched (good) your current instance to do way more than we thought it could.</li>
<li>Time to read the main Documentation of this Repo to have a basic knowledge of how this is deployed. Recommended even if you are not going to deploy one from scratch here.</li>
<li>For Shell Commands documented here please copy line by line—not the whole block.</li>
</ul>
<h2 id="differences-between-both-deployments-strategies">Differences between both deployments strategies.</h2>
<p>In a nutshell: <code>archipelago-deployment-live</code> uses a different folder structure moving configuration storage, data storage outside of your webroot, and allows a much finer control of your settings (safer) and Docker containers.
In a nutshell inside the first nutshell: <code>archipelago-deployment-live</code> also ignores more files so keeping customized versions, your own packages, your own settings around, and version controlled is much easier.
Lastly: <code>archipelago-deployment-live</code> makes more use of Cloud Services, e.g. so if you have been running <code>min.io</code> as local mounted storage you may now consider moving storage (files) to a cloud service like AWS S3.</p>
<h2 id="commonalities-between-both-deployment-strategies">Commonalities between both deployment strategies.</h2>
<p>In a nutshell: Since both run the same code and use the same Docker Containers, the data is actually the same. Everything is just persisted in different places.</p>
<h2 id="getting-the-new-repo-in-place">Getting the new repo in place</h2>
<p>First you need to clone this repository and (hopefully) store in the same parent folder to your current <code>archipelago-deployment</code> one. For the purpose of this tutorial we will assume you have <code>archipelago-deployment</code> cloned in this location: <code>$HOME/archipelago-deployment</code>.</p>
<p>Locate your <code>archipelago-deployment</code> folder in your terminal. Do an <code>ls</code> to make sure you can see the folder (not the content) and run:</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/esmero/archipelago-deployment-live
<span class="nb">cd</span> archipelago-deployment-live
git checkout <span class="m">1</span>.0.0-RC3
<span class="nb">cd</span> ..
<span class="nb">cd</span> archipelago-deployment
</code></pre></div>
<p>Now you have side by side <code>$HOME/archipelago_deployment</code> and <code>$HOME/archipelago-deployment-live</code>.</p>
<p>This will give you the base structure.</p>
<p>Before touching anything let's start by generating a backup of your current deployment (safety first).</p>
<h2 id="backing-up">Backing up</h2>
<h3 id="step-1">Step 1:</h3>
<p>Shut down your <code>docker-compose</code> ensemble. Inside your original <code>archipelago-deployment</code> folder run this:</p>
<div class="highlight"><pre><span></span><code>docker-compose down
</code></pre></div>
<h3 id="step-2">Step 2:</h3>
<p>Verify all containers are actually down:</p>
<div class="highlight"><pre><span></span><code>docker ps
</code></pre></div>
<p>The following command should return an empty listing. If anything is still running, wait a little longer and run the previous command again.</p>
<h3 id="step-3">Step 3:</h3>
<p>Now let's tar.gz the whole ensemble with data and configs. As an example we will save this into your <code>$HOME</code> folder.
As a good practice we append the <strong>current date</strong> (YEAR-MONTH-DAY) to the filename. Here we assume today is December 1st of 2021:</p>
<div class="highlight"><pre><span></span><code>sudo tar -czvpf <span class="nv">$HOME</span>/archipelago-deployment-backup-20211201.tar.gz ../archipelago-deployment
</code></pre></div>
<p>The process may take a few minutes. Now let's verify that all is there and that the <code>tar.gz</code> is not corrupt:</p>
<div class="highlight"><pre><span></span><code>tar -tvvf <span class="nv">$HOME</span>/archipelago-deployment-backup-20211201.tar.gz 
</code></pre></div>
<p>You will see a listing of files. If corrupt (do you have enough space? did your ssh connection drop?) you will see:</p>
<div class="highlight"><pre><span></span><code>tar: Unrecognized archive format
</code></pre></div>
<p>Done! If you are running a public instance we can allow ourselves to start Docker again to avoid downtime:</p>
<div class="highlight"><pre><span></span><code>docker-compose up -d
</code></pre></div>
<h2 id="the-directory-structures">The directory structures</h2>
<p>Now that you backed all up we can spend some minutes looking at both directory structures.</p>
<p>If you observe both deployment strategies side by side you will inmediately notice the most important similarities and also differences:</p>
<table>
    <tr>
        <th>archipelago-deployment Live</th>
        <th>archipelago-deployment</th>
    </tr>
    <tr>
        <td valign="top"><pre>.
├── config_storage
│   ├── iiifconfig
│   ├── nginxconfig
│   ├── nginxconfig_selfcert
│   ├── php-fpm
│   └── solrconfig
├── data_storage
│   ├── db
│   ├── iiifcache
│   ├── iiiftmp
│   ├── letsencrypt
│   ├── minio-data
│   ├── ngnixcache
│   ├── selfcert
│   ├── solrcore
│   └── solrlib
├── deploy
│   ├── azure-kubernetes
│   ├── ec2-docker
│   └── kubernetes
├── docs
└── drupal
│   ├── config
│   ├── d8content
│   ├── docs
│   ├── drush
│   ├── patches
│   ├── persistent
│   ├── private
│   ├── scripts
│   ├── vendor
│   ├── web
│   └── xdebug
</pre></td>
        <td valign="top"><pre>.
├── config
│   └── sync
├── d8content
│   └── metadatadisplays
├── docs
├── drush
│   ├── Commands
│   └── sites
├── nginxconfigford8
├── patches
├── persistent
│   ├── db
│   ├── iiifcache
│   ├── iiifconfig
│   ├── miniodata
│   ├── solrconfig
│   ├── solrcore
│   └── solrlib
├── private
│   └── webform
├── scripts
│   ├── archipelago
│   └── composer
├── vendor
│   ├── archipelago
│   ├── asm89
│   ├── aws
│   ├── behat
│   ├── bin
│   ├── brick
│   ├── chi-teck
│   ├── composer
│   ├── consolidation
│   ├── container-interop
│   ├── cweagans
│   ├── data-values
│   ├── dflydev
│   ├── doctrine
│   ├── drupal
│   ├── drush
│   ├── easyrdf
│   ├── egulias
│   ├── enlightn
│   ├── erusev
│   ├── evenement
│   ├── ezyang
│   ├── fabpot
│   ├── fileeye
│   ├── firebase
│   ├── frictionlessdata
│   ├── google
│   ├── graham-campbell
│   ├── grasmash
│   ├── guzzlehttp
│   ├── instaclick
│   ├── jcalderonzumba
│   ├── jean85
│   ├── jmikola
│   ├── justinrainbow
│   ├── laminas
│   ├── league
│   ├── lsolesen
│   ├── maennchen
│   ├── markbaker
│   ├── masterminds
│   ├── mglaman
│   ├── mhor
│   ├── mikey179
│   ├── mixnode
│   ├── ml
│   ├── monolog
│   ├── mtdowling
│   ├── myclabs
│   ├── nesbot
│   ├── nette
│   ├── nikic
│   ├── paragonie
│   ├── pear
│   ├── phar-io
│   ├── phenx
│   ├── phpdocumentor
│   ├── phplang
│   ├── phpmailer
│   ├── phpoffice
│   ├── phpoption
│   ├── phpseclib
│   ├── phpspec
│   ├── phpstan
│   ├── phpunit
│   ├── professional-wiki
│   ├── psr
│   ├── psy
│   ├── ralouphie
│   ├── ramsey
│   ├── react
│   ├── sebastian
│   ├── seld
│   ├── sirbrillig
│   ├── solarium
│   ├── squizlabs
│   ├── stack
│   ├── strawberryfield
│   ├── swaggest
│   ├── symfony
│   ├── symfony-cmf
│   ├── theseer
│   ├── twbs
│   ├── twig
│   ├── typo3
│   ├── vlucas
│   ├── web64
│   ├── webflo
│   ├── webmozart
│   ├── wikibase
│   ├── wikimedia
│   └── zaporylie
├── web
│   ├── core
│   ├── libraries
│   ├── modules
│   ├── profiles
│   ├── sites
│   └── themes</pre></td>
    </tr>
</table>

<h2 id="the-data">The Data</h2>
<p>Let's start by focusing on the <code>data</code>, in our case the Database, Solr, and File (S3 + Private) storage. Collapsing here a few folders will make this easier to read.
Marked with a <code>*</code> are matching folders that contain DB, Solr Core, the S3 min.io data (if you are using local storage) and also Drupal's very own <code>private</code> folder:</p>
<table>
    <tr>
        <th>archipelago-deployment Live</th>
        <th>archipelago-deployment</th>
    </tr>
    <tr>
        <td valign="top"><pre>.
├── config_storage
├── data_storage
│   ├── * db *
│   ├── iiifcache
│   ├── iiiftmp
│   ├── letsencrypt
│   ├── * minio-data *
│   ├── ngnixcache
│   ├── selfcert
│   ├── solrcore
│   └── solrlib
├── deploy
├── docs
└── drupal
│   ├── config
│   ├── d8content
│   ├── docs
│   ├── drush
│   ├── patches
│   ├── persistent
│   ├── * private *
│   ├── scripts
│   ├── vendor
│   ├── web
│   └── xdebug
</pre></td>
        <td valign="top"><pre>.
├── config
├── d8content
├── docs
├── drush
├── nginxconfigford8
├── patches
├── persistent
│   ├── * db *
│   ├── iiifcache
│   ├── iiifconfig
│   ├── * miniodata *
│   ├── solrconfig
│   ├── * solrcore *
│   └── solrlib
├── * private *
├── scripts
├── vendor
├── web
</pre></td>
    </tr>
</table>

<h3 id="copying-the-data-into-the-new-structure">Copying the Data into the new Structure</h3>
<p>To do so we need to stop Docker again. This is needed because Databases sometimes keep an open Change Log and Locks in place, and if there is any interaction or cron running, your data may end up corrupted.</p>
<h4 id="step-1_1">Step 1:</h4>
<p>Shut down your <code>docker-compose</code> ensemble. Inside your original <code>archipelago-deployment</code> folder run this:</p>
<div class="highlight"><pre><span></span><code>docker-compose down
</code></pre></div>
<h4 id="step-2_1">Step 2:</h4>
<p>Verify all containers are actually down:</p>
<div class="highlight"><pre><span></span><code>docker ps
</code></pre></div>
<h4 id="step-3_1">Step 3:</h4>
<p>We will copy DB, min.io (File and ADO storage as files) and Drupal's private (temporary files, caches) folders to its new place:</p>
<div class="highlight"><pre><span></span><code>sudo cp -rpv persistent/db ../archipelago-deployment-live/data_storage/db
sudo cp -rpv persistent/solrcore ../archipelago-deployment-live/data_storage/solrcore
sudo cp -rpv persistent/miniodata ../archipelago-deployment-live/data_storage/minio-data
sudo cp -rpv private ../archipelago-deployment-live/drupal/private
</code></pre></div>
<p>Running <code>-rpv</code> will copy verbosely and recursively while preserving original permissions.</p>
<p>Done!</p>
<p>You can now start <code>docker-compose</code> again:</p>
<div class="highlight"><pre><span></span><code>docker-compose up -d
</code></pre></div>
<h2 id="the-web">The Web</h2>
<p>Collapsing again a few folders to aid in readability, we can now focus on your actual Drupal/Archipelago Code/Web and settings. To be honest (we are), you can easily reinstall and restore all this via <code>composer</code>, but we can also move folders as a learning experience/time and bandwidth experience. Marked with a <code>*</code> are matching folders you want to copy over:</p>
<table>
    <tr>
        <th>archipelago-deployment Live</th>
        <th>archipelago-deployment</th>
    </tr>
    <tr>
        <td valign="top"><pre>.
├── config_storage
├── data_storage
├── deploy
├── docs
└── drupal
│   ├── * config *
│   ├── d8content
│   ├── docs
│   ├── drush
│   ├── patches
│   ├── persistent
│   ├── private
│   ├── scripts
│   ├── * vendor *
│   ├── * web *
│   └── xdebug
</pre></td>
        <td valign="top"><pre>.
├── * config *
│   └── sync
├── d8content
│   └── metadatadisplays
├── docs
├── drush
│   ├── Commands
│   └── sites
├── nginxconfigford8
├── patches
├── persistent
├── private
├── scripts
├── * vendor *
├── * web *
</pre></td>
    </tr>
</table>

<h3 id="copying-the-web-into-the-new-structure">Copying the Web into the new Structure</h3>
<p>No need to stop Docker again. We can do this while your Archipelago is still running.</p>
<h4 id="step-1_2">Step 1:</h4>
<p>We will copy all important folders over. From your <code>archipelago-deployment</code> folder run:</p>
<div class="highlight"><pre><span></span><code>sudo cp -rpv vendor ../archipelago-deployment-live/drupal/vendor
sudo cp -rpv web ../archipelago-deployment-live/drupal/web
sudo cp -rpv config ../archipelago-deployment-live/drupal/config
</code></pre></div>
<p>And also, selectively, a few files we know you are very fond of!</p>
<div class="highlight"><pre><span></span><code>sudo cp -rpv composer.json ../archipelago-deployment-live/drupal/composer.json
sudo cp -rpv composer.lock ../archipelago-deployment-live/drupal/composer.lock
</code></pre></div>
<p>Done!</p>
<h2 id="ssl-enviromentals-configurations-settings-and-docker">SSL, Enviromentals, Configurations, Settings and Docker</h2>
<p>We are almost done, but <code>archipelago-deployment-live</code> has a different, safer way of defining SSL Certs, credentials, and global settings for your Archipelago. 
We will start first by copying settings as they are (most likely not very safe), and then we can update passwords/etc. to make your system better-prepared for the world.</p>
<p>To learn more about these general settings please read <a href="../archipelago-deployment-live-readme/#step-3-setup-your-enviromental-variables-for-dockerservices">this section of the parent Documentation</a> (who likes duplicated documentation? Nobody.).
The gist here is (after reading, please do not skip) that we need to add our service definitions into a <code>.env</code> file.</p>
<p>Coming from <code>archipelago-deployment</code> means and assumes that you are running AWS Linux 2 using the suggested locations in this document, that you have a vanilla deployment, and that you followed <a href="https://github.com/esmero/archipelago-deployment/blob/1.0.0-RC2/archipelago-deployment-ubuntu.md">these instructions</a>) so your values for <code>$HOME/archipelago-deployment-live/deploy/ec2-docker/.env</code> will be the following:</p>
<div class="highlight"><pre><span></span><code><span class="nv">ARCHIPELAGO_ROOT</span><span class="o">=</span>/home/ec2-user/archipelago-deployment-live
<span class="nv">ARCHIPELAGO_EMAIL</span><span class="o">=</span>your@validemail.org
<span class="nv">ARCHIPELAGO_DOMAIN</span><span class="o">=</span>your.domain.org
<span class="nv">MINIO_ACCESS_KEY</span><span class="o">=</span>minio
<span class="nv">MINIO_SECRET_KEY</span><span class="o">=</span>minio123
<span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>esmero-db
<span class="nv">MINIO_BUCKET_MEDIA</span><span class="o">=</span>archipelago
<span class="nv">MINIO_FOLDER_PREFIX_MEDIA</span><span class="o">=</span>/
<span class="nv">MINIO_BUCKET_CACHE</span><span class="o">=</span>archipelago
<span class="nv">MINIO_FOLDER_PREFIX_CACHE</span><span class="o">=</span>/
</code></pre></div>
<p>If you plan on staying on local storage driven <code>min.io</code>, <code>MINIO_BUCKET_CACHE</code> and <code>MINIO_FOLDER_PREFIX_CACHE</code> are not going to be used. If you are planning on moving your Storage from local to cloud driven please replace with the right values, e.g. AWS IAM keys and Secrets + bucket names and prefixes (folders).
Again, refer to the <a href="../archipelago-deployment-live-readme/#step-3-setup-your-enviromental-variables-for-dockerservices">parent Documentation</a> for setting this up.</p>
<p>Once you have that in place (Double-check. If something goes wrong here we can always fine-tune and fix again.), we need to decide on a new <code>docker-compose</code> file, and you may need to customize it depending on your choices and current and future needs.</p>
<p>If you already have an SSL certificate, and it's provided by <code>CertBot</code> you can either copy the certs from your current system (will totally depend on your setup since <code>archipelago-deployment</code> does not provide out-of-the-box SSL Certs) to <code>$HOME/archipelago-deployment-live/data_storage/letsencrypt</code>.</p>
<p>A normal folder structure for that is:</p>
<div class="highlight"><pre><span></span><code>.
├── accounts
│   └── acme-v02.api.letsencrypt.org
│       └── directory
│           └── cac9f8218ef18e4f11ec053785bbf648
│               ├── meta.json
│               ├── private_key.json
│               └── regr.json
├── archive
│   ├── your.domain.org
│       ├── cert1.pem
│       ├── chain1.pem
│       ├── fullchain1.pem
│       └── privkey1.pem
│ 
├── csr
│   ├── 0000_csr-certbot.pem
│   ├── 0001_csr-certbot.pem
│   ├── 0002_csr-certbot.pem
│   └── 0003_csr-certbot.pem
├── keys
│   ├── 0000_key-certbot.pem
│   ├── 0001_key-certbot.pem
│   ├── 0002_key-certbot.pem
│   └── 0003_key-certbot.pem
├── live
│   ├── README
│   └── your.domain.org
│      ├── cert.pem -&gt; ../../archive/your.domain.org/cert1.pem
│      ├── chain.pem -&gt; ../../archive/your.domain.org/chain1.pem
│      ├── fullchain.pem -&gt; ../../archive/your.domain.org/fullchain1.pem
│      ├── privkey.pem -&gt; ../../archive/your.domain.org/privkey1.pem
│      └── README
├── renewal
│   └── your.domain.org.conf
│   
└── renewal-hooks
    ├── deploy
    ├── post
    └── pre
</code></pre></div>
<p>Or if your SSL cert is up for renewal, you can just let Archipelago request it for you. Renewal will happen auto-magically, and you may never ever need to worry about that in the future.</p>
<p>Finally, let's adapt the <code>docker-compose</code> file we need to our previous (but still current!) <code>archipelago-deployment</code> reality.</p>
<p>For x86/AMD, run (for ARM64/Apple M1 please check the <a href="../archipelago-deployment-live-readme/#deployment-on-arm64v8graviton-apple-m1-system">parent Documentation</a>):</p>
<div class="highlight"><pre><span></span><code>cp <span class="nv">$home</span>/archipelago-deployment-live/deploy/ec2-docker/docker-compose-aws-s3.yml <span class="nv">$home</span>/archipelago-deployment-live/deploy/ec2-docker/docker-compose.yml
nano <span class="nv">$home</span>/archipelago-deployment-live/deploy/ec2-docker/docker-compose.yml
</code></pre></div>
<p>And replace the content with this slightly modified version. Note: we really only changed the lines after this comment: <code># THIS DIFFERS FROM THE NORMAL ONE...</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Run docker-compose up -d</span>

version: <span class="s1">&#39;3.5&#39;</span>
services:
  web:
    container_name: esmero-web
    image: staticfloat/nginx-certbot
    restart: always
    environment:
      CERTBOT_EMAIL: <span class="si">${</span><span class="nv">ARCHIPELAGO_EMAIL</span><span class="si">}</span>
      ENVSUBST_VARS: FQDN
      FQDN: <span class="si">${</span><span class="nv">ARCHIPELAGO_DOMAIN</span><span class="si">}</span>
    ports:
      - <span class="s2">&quot;80:80&quot;</span>
      - <span class="s2">&quot;443:443&quot;</span>
    volumes:
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/config_storage/nginxconfig/conf.d:/etc/nginx/user.conf.d
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/config_storage/nginxconfig/certbot_extra_domains:/etc/nginx/certbot/extra_domains:ro
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/drupal:/var/www/html:cached
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/ngnixcache:/var/cache/nginx
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/letsencrypt:/etc/letsencrypt
    depends_on:
      - solr
      - php
      - db
    tty: <span class="nb">true</span>
    networks:
      - host-net
      - esmero-net
  php:
    container_name: esmero-php
    restart: always
    image: <span class="s2">&quot;esmero/php-7.4-fpm:1.0.0-RC2-multiarch&quot;</span>
    tty: <span class="nb">true</span>
    networks:
      - host-net
      - esmero-net
    volumes:
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/config_storage/php-fpm/www.conf:/usr/local/etc/php-fpm.d/www.conf
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/drupal:/var/www/html:cached
    environment:
      MINIO_ACCESS_KEY: <span class="si">${</span><span class="nv">MINIO_ACCESS_KEY</span><span class="si">}</span>
      MINIO_SECRET_KEY: <span class="si">${</span><span class="nv">MINIO_SECRET_KEY</span><span class="si">}</span>
      MYSQL_ROOT_PASSWORD: <span class="si">${</span><span class="nv">MYSQL_ROOT_PASSWORD</span><span class="si">}</span>
      MINIO_BUCKET_MEDIA: <span class="si">${</span><span class="nv">MINIO_BUCKET_MEDIA</span><span class="si">}</span>
      MINIO_FOLDER_PREFIX_MEDIA: <span class="si">${</span><span class="nv">MINIO_FOLDER_PREFIX_MEDIA</span><span class="si">}</span>
  solr:
    container_name: esmero-solr
    restart: always
    image: <span class="s2">&quot;solr:8.8.2&quot;</span>
    tty: <span class="nb">true</span>
    ports:
      - <span class="s2">&quot;8983:8983&quot;</span>
    networks:
      - host-net
      - esmero-net
    volumes:
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/solrcore:/var/solr/data
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/config_storage/solrconfig:/drupalconfig
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/solrlib:/opt/solr/contrib/archipelago/lib
    entrypoint:
      - docker-entrypoint.sh
      - solr-precreate
      - drupal
      - /drupalconfig
  db:
    image: mysql:8.0.22
    command: mysqld --default-authentication-plugin<span class="o">=</span>mysql_native_password  --max_allowed_packet<span class="o">=</span>256M
    container_name: esmero-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: <span class="si">${</span><span class="nv">MYSQL_ROOT_PASSWORD</span><span class="si">}</span>
    networks:
      - host-net
      - esmero-net
    volumes:
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/db:/var/lib/mysql
  nlp:
    container_name: esmero-nlp
    restart: always
    image: <span class="s2">&quot;esmero/esmero-nlp:1.0&quot;</span>
    ports:
      - <span class="s2">&quot;6400:6400&quot;</span>
    networks:
      - host-net
      - esmero-net
  iiif:
    container_name: esmero-cantaloupe
    image: <span class="s2">&quot;esmero/cantaloupe-s3:4.1.9RC&quot;</span>
    restart: always
    ports:
      - <span class="s2">&quot;8183:8182&quot;</span>
    networks:
      - host-net
      - esmero-net
    environment:
      AWS_ACCESS_KEY_ID: <span class="si">${</span><span class="nv">MINIO_ACCESS_KEY</span><span class="si">}</span>
      AWS_SECRET_ACCESS_KEY: <span class="si">${</span><span class="nv">MINIO_SECRET_KEY</span><span class="si">}</span>
      <span class="c1"># THIS DIFFERS FROM THE STANDARD ONE AND ENABLES LOCAL FILESYSTEM CACHE INSTEAD OF AWS S3 one</span>
      CACHE_SERVER_DERIVATIVE: FilesystemCache
      S3SOURCE_BASICLOOKUPSTRATEGY_BUCKET_NAME: <span class="si">${</span><span class="nv">MINIO_BUCKET_MEDIA</span><span class="si">}</span>
      S3SOURCE_BASICLOOKUPSTRATEGY_PATH_PREFIX: <span class="si">${</span><span class="nv">MINIO_FOLDER_PREFIX_MEDIA</span><span class="si">}</span>
      S3CACHE_BUCKET_NAME: <span class="si">${</span><span class="nv">MINIO_BUCKET_CACHE</span><span class="si">}</span> 
      S3CACHE_OBJECT_KEY_PREFIX: <span class="si">${</span><span class="nv">MINIO_FOLDER_PREFIX_CACHE</span><span class="si">}</span> 
      XMS: 2g
      XMX: 4g
    volumes:
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/config_storage/iiifconfig:/etc/cantaloupe
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/iiifcache:/var/cache/cantaloupe
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/iiiftmp:/var/cache/cantaloupe_tmp
  minio:
    container_name: esmero-minio
    restart: always
    image: minio/minio:latest
    volumes:
      - <span class="si">${</span><span class="nv">ARCHIPELAGO_ROOT</span><span class="si">}</span>/data_storage/minio-data:/data:cached
    ports:
      - <span class="s2">&quot;9000:9000&quot;</span>
      - <span class="s2">&quot;9001:9001&quot;</span>
    networks:
      - host-net
      - esmero-net
    environment:
      MINIO_HTTP_TRACE: /tmp/minio-log.txt
      MINIO_ROOT_USER: <span class="si">${</span><span class="nv">MINIO_ACCESS_KEY</span><span class="si">}</span>
      MINIO_ROOT_PASSWORD: <span class="si">${</span><span class="nv">MINIO_SECRET_KEY</span><span class="si">}</span>
      MINIO_ACCESS_KEY: <span class="si">${</span><span class="nv">MINIO_ACCESS_KEY</span><span class="si">}</span>
      MINIO_SECRET_KEY: <span class="si">${</span><span class="nv">MINIO_SECRET_KEY</span><span class="si">}</span>
      <span class="c1"># THIS DIFFERS FROM THE STANDARD ONE AND ENABLES LOCAL MINIO INSTEAD OF AWS S3 one </span>
    command: server /data --console-address <span class="s2">&quot;:9001&quot;</span>
networks:
  host-net:
    driver: bridge
  esmero-net:
    driver: bridge
    internal: <span class="nb">true</span>
</code></pre></div>
<p>Press CNTRL-X, and you are done.
Now the final test!!</p>
<h2 id="shutdown-the-old-one-start-the-new-one">Shutdown the old one, start the new one</h2>
<p>So we are ready. Testing may be a hit-or-miss thing here. Did we cover all the steps? Did a command fail? The good thing is that we can start the new ensemble, and all our old ones will survive. And we can come back over and over until we are ready. Let's try!</p>
<p>We will start by shutting down the running Docker ensemble:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$HOME</span>/archipelago-deployment
docker-compose down
</code></pre></div>
<p>Now let's go to our new deployment. Docker starts here in a different folder:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$HOME</span>/archipelago-deployment-live/deploy/ec2-docker
docker-compose up
</code></pre></div>
<p>You may notice that we removed the <code>-d</code>. Why? We want to see all the messages and notice/mark/copy any errors, e.g. did the SSL CERT load correctly? Did the MYSQL import work out?
To avoid shutting it down while all starts, please open another Terminal and type:</p>
<div class="highlight"><pre><span></span><code>docker ps
</code></pre></div>
<p>And look at the up-times. Do you see any Containers restarting (where Created and the Status differ for a lot and Status keeps resetting to 0?)? A healthy deployment will look similar to this:</p>
<div class="highlight"><pre><span></span><code>CONTAINER ID   IMAGE                                    COMMAND                  CREATED          STATUS         PORTS                                      NAMES
f794c25db64c   esmero/cantaloupe-s3:4.1.9RC2-arm64      <span class="s2">&quot;sh -c &#39;java -Dcanta…&quot;</span>   <span class="m">6</span> seconds ago    Up <span class="m">3</span> seconds   <span class="m">0</span>.0.0.0:8183-&gt;8182/tcp                     esmero-cantaloupe
5b791445720f   jonasal/nginx-certbot                    <span class="s2">&quot;/docker-entrypoint.…&quot;</span>   <span class="m">6</span> seconds ago    Up <span class="m">3</span> seconds   <span class="m">0</span>.0.0.0:80-&gt;80/tcp, <span class="m">0</span>.0.0.0:443-&gt;443/tcp   esmero-web
e38fbbd86edf   esmero/esmero-nlp:1.0.1-RC2-arm64        <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="m">11</span> seconds ago   Up <span class="m">6</span> seconds   <span class="m">0</span>.0.0.0:6400-&gt;6400/tcp                     esmero-nlp
c84a0a4d43e9   minio/minio:latest                       <span class="s2">&quot;/usr/bin/docker-ent…&quot;</span>   <span class="m">11</span> seconds ago   Up <span class="m">6</span> seconds   <span class="m">0</span>.0.0.0:9000-9001-&gt;9000-9001/tcp           esmero-minio
3ec176a960c3   esmero/php-7.4-fpm:1.0.0-RC2-multiarch   <span class="s2">&quot;docker-php-entrypoi…&quot;</span>   <span class="m">11</span> seconds ago   Up <span class="m">6</span> seconds   <span class="m">9000</span>/tcp                                   esmero-php
e762ad7ea5e2   solr:8.8.2                               <span class="s2">&quot;docker-entrypoint.s…&quot;</span>   <span class="m">11</span> seconds ago   Up <span class="m">6</span> seconds   <span class="m">0</span>.0.0.0:8983-&gt;8983/tcp                     esmero-solr
381166d61f8c   mariadb:10.5.10-focal                    <span class="s2">&quot;docker-entrypoint.s…&quot;</span>   <span class="m">11</span> seconds ago   Up <span class="m">6</span> seconds   <span class="m">3306</span>/tcp      
</code></pre></div>
<p>If you feel that all seems to be fine, open a browser window and visit your website. See if you can log in and see ADOs.
If not you can momentarily shut down this new Docker ensemble and restart the older one. Nothing is lost!
Then with time and tea/coffee and fresh eyes come back and re-trace your steps. 95% of the issues are incorrect values in the <code>.env</code> file. The other 5% may be on us.
If you run into any trouble please get in touch!</p>
<p>Happy deploying!</p>
<hr />
<p>Thank you for reading! Please contact us on our <a href="https://groups.google.com/forum/#!forum/archipelago-commons">Archipelago Commons Google Group</a> with any questions or feedback, or open an ISSUE in this <a href="https://github.com/esmero/archipelago-deployment-live/">Archipelago Deployment Live Repository</a>.</p>
<p>Return to <a href="../archipelago-deployment-live-readme/">Archipelago Live Deployment</a>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../archipelago-deployment-live-gitworkflow/" class="btn btn-neutral float-left" title="Github Workflow"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../archipelago-deployment-live-upgradeFromD8ToD9/" class="btn btn-neutral float-right" title="Upgrading Drupal 8 to Drupal 9 (1.0.0-RC2 to 1.0.0-RC3)">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../archipelago-deployment-live-gitworkflow/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../archipelago-deployment-live-upgradeFromD8ToD9/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
      <script src="../js/version-select.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
