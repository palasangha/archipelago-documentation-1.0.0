<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The Digital Services Team at Metropolitan New York Library Council" /><link rel="canonical" href="http://docs.archipelago.nyc/sslsetup/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>How to Set Up SSL for Docker/Archipelago - Pala Archipelago Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "How to Set Up SSL for Docker/Archipelago";
        var mkdocs_page_input_path = "sslsetup.md";
        var mkdocs_page_url = "/sslsetup/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../images/dhammacakka.png" class="logo" alt="Logo"/>
        </a>
        <div class="version">
          {'provider': 'mike', 'default': 'default'}
        </div><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">About Archipelago</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ourtake/">Archipelago's Philosophy & Guiding Principles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../strawberryfields/">Strawberryfields Forever</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../devops/">Software Services</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT/">Code of Conduct</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Instructions and Guides</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="#">Archipelago-Deployment</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-readme/">Start</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-osx/">Installing Archipelago Drupal 9 on OSX (macOS)</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-ubuntu/">Installing Archipelago Drupal 9 on Ubuntu 18.04 or 20.04</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-democontent/">Adding Demo Archipelago Digital Objects (ADOs) to your Repository</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-upgradeFromD8ToD9/">Upgrading Drupal 8 to Drupal 9 (1.0.0-RC2 to 1.0.0-RC3)</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Archipelago-Deployment-Live</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-live-readme/">Start</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-live-gitworkflow/">Github Workflow</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-live-moveToLive/">Moving from archipelago-deployment to archipelago-deployment-live</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archipelago-deployment-live-upgradeFromD8ToD9/">Upgrading Drupal 8 to Drupal 9 (1.0.0-RC2 to 1.0.0-RC3)</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Archipelago 101</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="#">Digital Objects and Collections, Metadata, General Workflows</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../firstobject/">Ingesting Your First Object</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Webforms in Archipelago</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../webforms/">Webforms</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../webformsasinput/">How to Create a Webform as an Input Method for Archipelago Digital Objects (ADO)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../modifyingfileextensionsinwebform/">Customizing Webforms (Modifying allowable file extensions)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../customwebformelements/">Archipelago Custom Webform Elements</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Twig Templates and Archipelago</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../metadatatwigs/">Twig Templates and Archipelago</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../workingtwigs/">Working With Twig in Archipelago (getting started with custom Twig templates)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="#">Archipelago Multi-Importer (AMI)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../ami_index/">Archipelago Multi-Importer (AMI)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="#">AMI Instructions and Guides</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../annotations/">Annotations</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Site Administration & Configuration</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../strawberryfield-formatters/">Strawberryfield Formatters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../createdisplaymodes/">Creating Display Modes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../archifilepersistencestrategy/">Archipelago's File Persistence Strategy</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">How to Set Up SSL for Docker/Archipelago</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#manual-configuration-steps-for-an-ec2-aws-server">Manual Configuration Steps for an EC2 AWS Server</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#user-contributed-documentation">User contributed documentation:</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../xdebug/">Debugging PHP in Archipelago</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">General Q&A</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_index/">General Q&A</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_twig_modules_configuration/">Twig Modules Configuration</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_smtp_configuration/">SMTP Configuration</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../generalqa_minio_logging/">Min.io Logging</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional Information</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../presentations_docs/">Archipelago Presentations and Documents</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inthewild/">Archipelagos in the Wild</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../giveortake/">Contribution Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../about/">About This Documentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../acknowledgments/">Care & Coding + Fixing / Acknowledgments / License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Pala Archipelago Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Instructions and Guides &raquo;</li>
          <li>Site Administration & Configuration &raquo;</li>
      <li>How to Set Up SSL for Docker/Archipelago</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="how-to-setup-ssl-for-dockerarchipelago">How to Setup SSL for Docker/Archipelago</h1>
<p><em><em>Work-In-Progress Note</em> This documentation page is still under construction and content may change with future updates. Please use caution when implementing any instructions referenced herein, as there may be missing steps or corresponding configuration files. Thank you for your patience as we continue to update Archipelago's documentation.</em></p>
<p>The steps found below describe one potential manual SSL configuration for Archipelago deployments. A <code>git clone</code> deployment option will be available for future releases.</p>
<h3 id="manual-configuration-steps-for-an-ec2-aws-server">Manual Configuration Steps for an EC2 AWS Server</h3>
<p>This process takes less than 10 minutes of reading YML files and editing a few files (described below) to get SSL running and setup with auto-renewal.</p>
<ol>
<li>
<p>First, configure Certbot, following the instructions found on https://certbot.eff.org.</p>
</li>
<li>
<p>Inside a /persistent partition, establish the following folder structure.
<em>Note: you can keep the existing folder structure if you so choose. A benefit of the following structure is that it decouples the git clone of archipelago-deployment, which is made to be self sustainable and good for coding or smaller deployments.</em></p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>ec2-user@ip-17x-xx-x-xxx persistent<span class="o">]</span>$ ls -lah
total 64K
drwxr-xr-x <span class="m">14</span> root           root  <span class="m">4</span>.0K Oct  <span class="m">5</span> <span class="m">23</span>:11 .
dr-xr-xr-x <span class="m">19</span> root           root  <span class="m">275</span> Dec <span class="m">15</span>  <span class="m">2019</span> ..
drwxr-xr-x  <span class="m">8</span>       <span class="m">999</span>  <span class="m">999</span>   <span class="m">4096</span> Oct <span class="m">13</span> <span class="m">20</span>:07 db
drwxr-xr-x <span class="m">13</span> root           root  <span class="m">4</span>.0K Oct  <span class="m">5</span> <span class="m">23</span>:03 drupal8
drwxr-xr-x  <span class="m">5</span>           <span class="m">8183</span>  <span class="m">8183</span>   <span class="m">4</span>.0K Feb <span class="m">23</span>  <span class="m">2020</span> iiifcache
drwxr-xr-x  <span class="m">2</span> root           root  <span class="m">4</span>.0K Feb <span class="m">23</span>  <span class="m">2020</span> iiifconfig
drwxr-xr-x  <span class="m">4</span> root           root  <span class="m">4</span>.0K Oct  <span class="m">5</span> <span class="m">22</span>:45 nginx_conf
drwxr-xr-x  <span class="m">3</span> root           root  <span class="m">4</span>.0K Feb <span class="m">26</span>  <span class="m">2019</span> solrconfig
drwxr-xr-x  <span class="m">3</span>           <span class="m">8983</span> <span class="m">8983</span>  <span class="m">4</span>.0K Feb <span class="m">26</span>  <span class="m">2019</span> solrcore
</code></pre></div>
<p>To get to this point, create a git clone of archipelago deployment and then copy the content of the /persistent out of the repo folder into this structure. The original (or what is left) archipelago-deployment ends inside a drupal8 folder here.</p>
</li>
<li>
<p>Copy and paste the following to create a local copy of this file:</p>
<details class="info">
<summary>docker-compose.yml</summary>
<p>**Be sure to replace youremail@gmail.com with your email address.</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.5&#39;</span><span class="w"></span>
<span class="w"> </span><span class="nt">services</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">web</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-web</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">staticfloat/nginx-certbot</span><span class="w"></span>
<span class="w">     </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">     </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">CERTBOT_EMAIL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;youremail@gmail.com&quot;</span><span class="w"></span>
<span class="w">     </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:80&quot;</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:443&quot;</span><span class="w"></span>
<span class="w">     </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/nginx_conf/conf.d:/etc/nginx/user.conf.d:ro</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/nginx_conf/certbot_extra_domains:/etc/nginx/certbot/extra_domains:ro</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/drupal8:/var/www/html:cached</span><span class="w"></span>
<span class="w">     </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">solr</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php</span><span class="w"></span>
<span class="w">     </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">     </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host-net</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-net</span><span class="w"></span>
<span class="w">   </span><span class="nt">php</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-php</span><span class="w"></span>
<span class="w">     </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;esmero/php-7.3-fpm:latest&quot;</span><span class="w"></span>
<span class="w">     </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">     </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host-net</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-net</span><span class="w"></span>
<span class="w">     </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${PWD}:/var/www/html:cached</span><span class="w"></span>
<span class="w">   </span><span class="nt">solr</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-solr</span><span class="w"></span>
<span class="w">     </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;solr:7.5.0&quot;</span><span class="w"></span>
<span class="w">     </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">     </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8983:8983&quot;</span><span class="w"></span>
<span class="w">     </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host-net</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-net</span><span class="w"></span>
<span class="w">     </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/solrcore:/opt/solr/server/solr/mycores:cached</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/solrconfig:/drupalconfig:cached</span><span class="w"></span>
<span class="w">     </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker-entrypoint.sh</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">solr-precreate</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drupal</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/drupalconfig</span><span class="w"></span>
<span class="w">   </span><span class="c1"># see https://hub.docker.com/_/mysql/</span><span class="w"></span>
<span class="w">   </span><span class="nt">db</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:5.7</span><span class="w"></span>
<span class="w">     </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max_allowed_packet=256M</span><span class="w"></span>
<span class="w">     </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-db</span><span class="w"></span>
<span class="w">     </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">     </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmerodb</span><span class="w"></span>
<span class="w">     </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host-net</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-net</span><span class="w"></span>
<span class="w">     </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/db:/var/lib/mysql:cached</span><span class="w"></span>
<span class="w">   </span><span class="nt">iiif</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-cantaloupe</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;esmero/cantaloupe-s3:4.1.6&quot;</span><span class="w"></span>
<span class="w">     </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">     </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8183:8182&quot;</span><span class="w"></span>
<span class="w">     </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host-net</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esmero-net</span><span class="w"></span>
<span class="w">     </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/iiifconfig:/etc/cantaloupe</span><span class="w"></span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/persistent/iiifcache:/var/cache/cantaloupe</span><span class="w"></span>
<span class="w"> </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">host-net</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span><span class="w"></span>
<span class="w">   </span><span class="nt">esmero-net</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span><span class="w"></span>
<span class="w">     </span><span class="nt">internal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</code></pre></div>
</details>
<p><em>Note: This file shows how the folders in Step 1 are being used, and how SSL is being automatically deployed and renewed (without any human interaction other than starting the docker-compose and watching the logs).</em></p>
</li>
<li>
<p>Now copy and paste the following to create a local copy of this file:</p>
<details class="info">
<summary>ngnix.conf</summary>
<p>**Be sure to replace all instances of yoursite.org with your own domain.</p>
<div class="highlight"><pre><span></span><code> <span class="c1"># goes into /persistent/nginx_conf/conf.d/nginx.conf</span>
 upstream cantaloupe <span class="o">{</span>
  server  esmero-cantaloupe:8182<span class="p">;</span>
  <span class="o">}</span>

  server <span class="o">{</span>
    listen              <span class="m">443</span> ssl<span class="p">;</span>
    server_name         yoursite.org<span class="p">;</span>
    ssl_certificate     /etc/letsencrypt/live/yourstie.org/fullchain.pem<span class="p">;</span>
    ssl_certificate_key /etc/letsencrypt/live/yoursite.org/privkey.pem<span class="p">;</span>

     client_max_body_size 512M<span class="p">;</span> <span class="c1">## Match with PHP from FPM container</span>

    root /var/www/html/web<span class="p">;</span> <span class="c1">## &lt;-- Your only path reference.</span>

    fastcgi_send_timeout 120s<span class="p">;</span>
    fastcgi_read_timeout 120s<span class="p">;</span>
    fastcgi_pass_request_headers on<span class="p">;</span>

    fastcgi_buffers <span class="m">16</span> 16k<span class="p">;</span>
    fastcgi_buffer_size 32k<span class="p">;</span>

    <span class="c1"># Cantaloupe proxypass</span>
    location /cantaloupe/ <span class="o">{</span>
       proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
       proxy_set_header X-Forwarded-Host <span class="nv">$host</span><span class="p">;</span>
       proxy_set_header X-Forwarded-Port <span class="nv">$server_port</span><span class="p">;</span>
       proxy_set_header X-Forwarded-Path /cantaloupe/<span class="p">;</span>
       proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
       <span class="k">if</span> <span class="o">(</span><span class="nv">$request_uri</span> ~* <span class="s2">&quot;/cantaloupe/(.*)&quot;</span><span class="o">)</span> <span class="o">{</span>
         proxy_pass http://cantaloupe/<span class="nv">$1</span><span class="p">;</span>
       <span class="o">}</span>
    <span class="o">}</span>

    <span class="nv">location</span> <span class="o">=</span> /favicon.ico <span class="o">{</span>
        log_not_found off<span class="p">;</span>
        access_log off<span class="p">;</span>
    <span class="o">}</span>

    <span class="nv">location</span> <span class="o">=</span> /robots.txt <span class="o">{</span>
        allow all<span class="p">;</span>
        log_not_found off<span class="p">;</span>
        access_log off<span class="p">;</span>
    <span class="o">}</span>

    <span class="c1"># Very rarely should these ever be accessed outside of your lan</span>
    location ~* <span class="se">\.</span><span class="o">(</span>txt<span class="p">|</span>log<span class="o">)</span>$ <span class="o">{</span>
        deny all<span class="p">;</span>
    <span class="o">}</span>

    location ~ <span class="se">\.</span>.*/.*<span class="se">\.</span>php$ <span class="o">{</span>
        <span class="k">return</span> <span class="m">403</span><span class="p">;</span>
    <span class="o">}</span>

    location ~ ^/sites/.*/private/ <span class="o">{</span>
        <span class="k">return</span> <span class="m">403</span><span class="p">;</span>
    <span class="o">}</span>

    <span class="c1"># Allow &quot;Well-Known URIs&quot; as per RFC 5785</span>
    location ~* ^/.well-known/ <span class="o">{</span>
        allow all<span class="p">;</span>
    <span class="o">}</span>

    <span class="c1"># Block access to &quot;hidden&quot; files and directories whose names begin with a</span>
    <span class="c1"># period. This includes directories used by version control systems such</span>
    <span class="c1"># as Subversion or Git to store control files.</span>
    location ~ <span class="o">(</span>^<span class="p">|</span>/<span class="o">)</span><span class="se">\.</span> <span class="o">{</span>
        <span class="k">return</span> <span class="m">403</span><span class="p">;</span>
    <span class="o">}</span>

    location / <span class="o">{</span>
        try_files <span class="nv">$uri</span> /index.php?<span class="nv">$query_string</span><span class="p">;</span> <span class="c1"># For Drupal &gt;= 7</span>
    <span class="o">}</span>

    location @rewrite <span class="o">{</span>
        rewrite ^/<span class="o">(</span>.*<span class="o">)</span>$ /index.php?q<span class="o">=</span><span class="nv">$1</span><span class="p">;</span>
    <span class="o">}</span>

    <span class="c1"># Don&#39;t allow direct access to PHP files in the vendor directory.</span>
    location ~ /vendor/.*<span class="se">\.</span>php$ <span class="o">{</span>
        deny all<span class="p">;</span>
        <span class="k">return</span> <span class="m">404</span><span class="p">;</span>
    <span class="o">}</span>

    <span class="c1"># Allow Modules to be updated via UI (still we believe composer is the way)    </span>
    rewrite ^/core/authorize.php/core/authorize.php<span class="o">(</span>.*<span class="o">)</span>$ /core/authorize.php<span class="nv">$1</span><span class="p">;</span>

    <span class="c1"># In Drupal 8, we must also match new paths where the &#39;.php&#39; appears in</span>
    <span class="c1"># the middle, such as update.php/selection. The rule we use is strict,</span>
    <span class="c1"># and only allows this pattern with the update.php front controller.</span>
    <span class="c1"># This allows legacy path aliases in the form of</span>
    <span class="c1"># blog/index.php/legacy-path to continue to route to Drupal nodes. If</span>
    <span class="c1"># you do not have any paths like that, then you might prefer to use a</span>
    <span class="c1"># laxer rule, such as:</span>
    <span class="c1">#   location ~ \.php(/|$) {</span>
    <span class="c1"># The laxer rule will continue to work if Drupal uses this new URL</span>
    <span class="c1"># pattern with front controllers other than update.php in a future</span>
    <span class="c1"># release.</span>
    location ~ <span class="s1">&#39;\.php$|^/update.php&#39;</span> <span class="o">{</span>
        fastcgi_split_path_info ^<span class="o">(</span>.+?<span class="se">\.</span>php<span class="o">)(</span><span class="p">|</span>/.*<span class="o">)</span>$<span class="p">;</span>
        include fastcgi_params<span class="p">;</span>
        <span class="c1"># Block httpoxy attacks. See https://httpoxy.org/.</span>
        fastcgi_param HTTP_PROXY <span class="s2">&quot;&quot;</span><span class="p">;</span>
        fastcgi_param SCRIPT_FILENAME <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
        fastcgi_param PATH_INFO <span class="nv">$fastcgi_path_info</span><span class="p">;</span>
        fastcgi_param PHP_VALUE <span class="s2">&quot;upload_max_filesize=512M \n post_max_size=512M&quot;</span><span class="p">;</span>
        proxy_read_timeout 900s<span class="p">;</span>
        fastcgi_intercept_errors on<span class="p">;</span>
        fastcgi_pass esmero-php:9000<span class="p">;</span>
    <span class="o">}</span>

     <span class="c1"># Fighting with Styles? This little gem is amazing.</span>
    location ~ ^/sites/.*/files/styles/ <span class="o">{</span> <span class="c1"># For Drupal &gt;= 7</span>
        try_files <span class="nv">$uri</span> @rewrite<span class="p">;</span>
    <span class="o">}</span>

    <span class="c1"># Handle private files through Drupal.</span>
    location ~ ^/system/files/ <span class="o">{</span> <span class="c1"># For Drupal &gt;= 7</span>
        try_files <span class="nv">$uri</span> /index.php?<span class="nv">$query_string</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
</details>
</li>
<li>
<p>Create the following folder:</p>
<div class="highlight"><pre><span></span><code>/persistent/nginx_conf/conf.d/
</code></pre></div>
</li>
<li>
<p>Place the ngnix.conf file inside the <code>/conf.d/</code> folder.</p>
</li>
<li>
<p>Create also this other folder:</p>
<div class="highlight"><pre><span></span><code>/persistent/nginx_conf/certbot_extra_domains/
</code></pre></div>
</li>
<li>
<p>Inside the <code>/certbot_extra_domains/</code> folder, create a text file named the same way as your domain (which can/or not contain additional subdomains but needs to exist).</p>
<div class="highlight"><pre><span></span><code>cat  /persistent/nginx_conf/certbot_extra_domains/yoursite.org
</code></pre></div>
<div class="highlight"><pre><span></span><code>drwxr-xr-x <span class="m">2</span> root root <span class="m">4</span>.0K Oct  <span class="m">5</span> <span class="m">22</span>:46 .
drwxr-xr-x <span class="m">4</span> root root <span class="m">4</span>.0K Oct  <span class="m">5</span> <span class="m">22</span>:45 ..
-rw-r--r-- <span class="m">1</span> root root   <span class="m">48</span> Oct  <span class="m">5</span> <span class="m">22</span>:46 yoursite.org
</code></pre></div>
<p><em>Optionally, create additional subdomains if needed.</em></p>
<div class="highlight"><pre><span></span><code>cat  /persistent/nginx_conf/certbot_extra_domains/yoursite.org
subdomain.yoursite.org
anothersub.yoursite.org
</code></pre></div>
</li>
<li>
<p>Make sure you have edited the <code>docker-compose.yml</code> and <code>ngnix.conf</code> files you created to match your own information. Also make sure to also adjust the paths if you do not want the /persistent approach described in Step 1.</p>
</li>
<li>
<p>Run the following commands:</p>
<div class="highlight"><pre><span></span><code>docker -compose up -d
docker ps
</code></pre></div>
<p>You should see this:</p>
<div class="highlight"><pre><span></span><code>b5a04747ee06        staticfloat/nginx-certbot    <span class="s2">&quot;/bin/bash /scripts/…&quot;</span>   <span class="m">8</span> days ago          Up <span class="m">8</span> days           <span class="m">0</span>.0.0.0:80-&gt;80/tcp, <span class="m">0</span>.0.0.0:443-&gt;443/tcp   esmero-web
84afae094b57        esmero/php-7.3-fpm:latest    <span class="s2">&quot;docker-php-entrypoi…&quot;</span>   <span class="m">8</span> days ago          Up <span class="m">8</span> days           <span class="m">9000</span>/tcp                                   esmero-php
13a9214acfd0        esmero/cantaloupe-s3:4.1.6   <span class="s2">&quot;sh -c &#39;java -Dcanta…&quot;</span>   <span class="m">8</span> days ago          Up <span class="m">8</span> days           <span class="m">0</span>.0.0.0:8183-&gt;8182/tcp                     esmero-cantaloupe
044dd5bc7245        mysql:5.7                    <span class="s2">&quot;docker-entrypoint.s…&quot;</span>   <span class="m">8</span> days ago          Up <span class="m">8</span> days           <span class="m">3306</span>/tcp, <span class="m">33060</span>/tcp                        esmero-db
31f4f0f45acc        solr:7.5.0                   <span class="s2">&quot;docker-entrypoint.s…&quot;</span>   <span class="m">8</span> days ago          Up <span class="m">8</span> days           <span class="m">0</span>.0.0.0:8983-&gt;8983/tcp                     esmero-solr
</code></pre></div>
</li>
<li>
<p>SSL has now been configured for your Archipelago instance.</p>
</li>
</ol>
<h3 id="user-contributed-documentation">User contributed documentation:</h3>
<p><em>Adding SSL to Archipelago running docker</em> by <a href="https://github.com/senyzspalding">Zachary Spalding</a>: <a href="https://youtu.be/rfH5TLzIRIQ">https://youtu.be/rfH5TLzIRIQ</a></p>
<hr />
<p>Thank you for reading! Please contact us on our <a href="https://groups.google.com/forum/#!forum/archipelago-commons">Archipelago Commons Google Group</a> with any questions or feedback.</p>
<p>Return to the <a href="..">Archipelago Documentation main page</a>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../archifilepersistencestrategy/" class="btn btn-neutral float-left" title="Archipelago's File Persistence Strategy"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../xdebug/" class="btn btn-neutral float-right" title="Debugging PHP in Archipelago">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../archifilepersistencestrategy/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../xdebug/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
      <script src="../js/version-select.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
